<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article is a sequel to my <a href="https://valor-software.com/articles/tasty-recipes-for-react-d3-the-ranking-bar" target="_blank" rel="noopener">previous article</a>.
In this new article, I&#8217;ll describe precisely the same task, but I&#8217;m going to change common and popular React to something completely different. That&#8217;s why I strongly recommend reading the previous article.</p>
</div>
<div class="paragraph">
<p>Some time ago, I faced a new framework. I asked myself&#8230;&#8203; Is it a new animal in the Framework Zoo? I have worked in IT for over 25 years and always await a "miracle." It doesn&#8217;t matter if it is Frontend, Backend, a new programming language, or DBMS. I&#8217;m trying to answer the following question for every new trend app. Will this app become mainstream? On the one hand, I remember a lot of stories such as "Angular," "React," "NodeJS," "Golang," "Postgres," "Microsoft C++," and "FoxPro." On the other hand, I remember another set of stories: "Backbone," "D Programming Language," "Polymer," "OrientDB," "Powesoft Power Builder," and "Microsoft Site Server"&#8230;&#8203; I hope you guess what the difference between these lists is. Of course, I don&#8217;t want to belittle software from the second list. But some of the software is destined to be more popular than others.</p>
</div>
<div class="paragraph">
<p>So, meet a new Framework Qwik! I am fond of predictions, but I&#8217;m not magical. I don&#8217;t know if Qwik will grab developers' minds in the nearest future. Despite that, Qwik looks like a very perspective framework. "Framework reimagined for the edge" - tells us the homepage. I like this approach. I like when an author rejects any annoying legacy and starts the project from scratch according to previous experiences. Moreover, performance is a doppelganger of Qwik. Sounds exciting!</p>
</div>
<div class="paragraph">
<p>Generally, coding on Qwik looks close to React, which allows gaining a lot of developers from React society. Despite Qwik concept being a bit different. Unlike other frameworks, Qwik is resumable, which means Qwik applications require 0 hydration. This allows Qwik apps to have instant-on interactivity, regardless of size or complexity. Honestly, my article is mainly for React developers. But if you are not React guy, don&#8217;t worry; dig into the <a href="https://qwik.builder.io/" target="_blank" rel="noopener">official resource</a> a bit more elaborative. If you are React guy and want to start from the practice immediately, the <a href="https://qwik.builder.io/docs/components/overview/" target="_blank" rel="noopener">Qwik Components Concept</a> would be very useful. The article&#8217;s primary goal is to illustrate how to work with the framework. That&#8217;s why I&#8217;m not going to provide Qwik technical knowledge as the Official Documentation does. I aim to guide you in Qwik World via links and examples. Unlike the previous article, I used Typescript in my examples because this language is used in Qwik by default. Also, my examples below are not production ready. That&#8217;s why don&#8217;t criticize them so much:) Especially for "@ts-ignore."</p>
</div>
<div class="paragraph">
<p>Only one exciting thing I want to tell you looking ahead. My Qwik-based code turned out more elegant than React-based! This fact could be an excellent impact to learn and use of Qwik.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bootstrapping">Bootstrapping</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_stackblitz">Stackblitz</h3>
<div class="paragraph">
<p>I like Stackblitz as a cloud prototyping tool. It has a lot of different presets such as Angular, React, etc. But it hasn&#8217;t Qwik preset because this framework is too young. Despite that, I found the following <a href="https://stackblitz.com/edit/qwik-starter?file=README.md" target="_blank" rel="noopener">custom starter</a>.
I&#8217;m going to explain what should you modify to work with Qwik and D3.</p>
</div>
<div class="paragraph">
<p>First, we need to change one dependency in <mark>package.json</mark>.</p>
</div>
<div class="paragraph">
<p>From:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"@builder.io/qwik": "^0.15.2",</code></pre>
</div>
</div>
<div class="paragraph">
<p>To:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"@builder.io/qwik": "^0.16.1",</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secondly, we need to install the following new dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"@types/d3": "7.4.0",
"d3": "^7.8.0",</code></pre>
</div>
</div>
<div class="paragraph">
<p>Qwik forces us to follow a particular convention. Please, read the helpful info <a href="https://qwik.builder.io/qwikcity/directory-layout/" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="paragraph">
<p>Actually, we are talking here more than Qwik. In this project, I use <a href="https://qwik.builder.io/qwikcity/overview/" target="_blank" rel="noopener">Qwik City</a>. We call it a meta-framework for Qwik. Qwik City is to Qwik, what Next.js is to React, what Nuxt is to Vue, or SvelteKit to Svelte.</p>
</div>
<div class="paragraph">
<p>All my future activities will be related to these conventions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_traditional_bootstrapping">Traditional Bootstrapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Of course, I use Stackblitz here only to illustrate my thoughts interactively. In real life, you need to use another approach for project bootstrapping. Fortunately, Qwik has a perfect bootstrapper. If you want to start a new project, please run the following command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">npm create qwik@latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please, read <a href="https://qwik.builder.io/docs/getting-started/" target="_blank" rel="noopener">Getting Started Qwik</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_scratches">First Scratches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I prefer to explain more complicated ideas via smaller sequential examples. That&#8217;s why before we proceed with Ranking Bars, I&#8217;d like to provide a more straightforward example that we will modify to the goal in the future. In the first step, we need to get the app that displays the following information via D3.</p>
</div>
<div class="imageblock img">
<div class="content">
<img src="assets/articles/a-qwik-view-of-the-ranking-bar/img1.png" alt="img1">
</div>
</div>
<div class="paragraph">
<p>First, you can find the solution below <a href="https://stackblitz.com/edit/qwik-starter-xxdte4?file=README.md" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="paragraph">
<p>The app should recalculate and redraw the dimension values for every window size change.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s remove all content from <mark>routes</mark> folder and put the following <mark>index.tsx</mark> instead.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import { component$ } from "@builder.io/qwik";
import App from "../components/app";

export default component$(() =&gt; &lt;App /&gt;);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Only one <mark>index.tsx</mark> means that we use only one "root" route.</p>
</div>
<div class="paragraph">
<p>Now we need to clean <mark>components</mark> folder.</p>
</div>
<div class="paragraph">
<p>Put <mark>app.tsx</mark> contains <mark>App</mark> component in <mark>components</mark> folder.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import { component$ } from "@builder.io/qwik";
import Chart from "./chart";

export default component$(() =&gt; &lt;Chart /&gt;);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following file <mark>chart.tsx</mark> contains <mark>Chart</mark> component.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import {
  component$,
  useStore,
  useClientEffect$,
  useSignal,
  useOnWindow,
  useTask$,
  $,
} from "@builder.io/qwik";
import * as d3 from "d3";
import { setSvgDimension } from "./utils";

export default component$(() =&gt; {
  const store = useStore({ width: 0, height: 0 });
  const svgRef = useSignal&lt;Element&gt;();

  useClientEffect$(() =&gt; {
    setSvgDimension(svgRef, store);
  });

  useOnWindow(
    "resize",
    $(() =&gt; {
      setSvgDimension(svgRef, store);
    })
  );

  useTask$(({ track }: { track: Function }) =&gt; {
    track(() =&gt; store.width);
    track(() =&gt; store.height);
    render(svgRef, store.width, store.height);
  });

  return &lt;svg class="chart" ref={svgRef} /&gt;;
});

export function render(svgRef: any, width: number, height: number) {
  d3.select(svgRef.value).select(".dimenstion-text").remove();

  const svg = d3
    .select(svgRef.value)
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(0,0)");

  svg
    .append("text")
    .text("Hello Qwik!")
    .attr("x", 10)
    .attr("y", 50)
    .attr("width", 200)
    .attr("fill", "red");

  svg
    .append("text")
    .text(`Width = ${width}px | Height = ${height}px`)
    .attr("class", "dimenstion-text")
    .attr("x", 10)
    .attr("y", 80)
    .attr("width", 200)
    .attr("fill", "black");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, you can find <mark>setSvgDimension</mark> code in <mark>utils.ts</mark>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import { Signal } from "@builder.io/qwik";

export function setSvgDimension(
  svgRef: Signal&lt;Element | undefined&gt;,
  store: any
) {
  if (svgRef?.value) {
    const { width, height } = svgRef.value.getBoundingClientRect();
    store.width = width;
    store.height = height;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let me comment some important points.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The component returns SVG, as in the previous article&#8217;s example.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>return &lt;svg class="chart" ref={svgRef} /&gt;;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><mark>useSignal</mark> allows us to work with the element above.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>const svgRef = useSignal&lt;Element&gt;();</pre>
</div>
</div>
<div class="paragraph">
<p>You can find more info regarding <mark>useSignal</mark> <a href="https://qwik.builder.io/tutorial/hooks/use-signal/" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>According to <a href="https://qwik.builder.io/tutorial/hooks/use-client-effect/" target="_blank" rel="noopener">this</a>: <mark>Use useClientEffect$() to execute code after the component is resumed. This is useful for setting up timers or streams on the client when the application is resumed.</mark></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In my example, the following code sets component dimensions and puts them in the store.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">useClientEffect$(() =&gt; {
  setSvgDimension(svgRef, store);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case <mark>useClientEffect$</mark> behaviour is similar to the following code in React.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">useEffect(() =&gt; {
  // init the component here...
}, []);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><mark>useOnWindow</mark> / <mark>useOn()</mark> / <mark>useOnDocument()</mark> are powerful ways to work with related listeners. In the code fragment below, we use <mark>useOnWindow</mark> to listen to every window size change.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">useOnWindow(
  "resize",
  $(() =&gt; {
    setSvgDimension(svgRef, store);
  })
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find more information regarding hooks above <a href="https://qwik.builder.io/tutorial/hooks/use-on/" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following line of code demonstrates to us how to store Qwik-trackable variables.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>const store = useStore({ width: 0, height: 0 });</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The following code allows to track related store variables changes.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">useTask$(({ track }: { track: Function }) =&gt; {
  track(() =&gt; store.width);
  track(() =&gt; store.height);
  // new render when window size has changed
  render(svgRef, store.width, store.height);
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can find more information regarding approaches above: <a href="https://qwik.builder.io/tutorial/hooks/use-task/" target="_blank" rel="noopener">useTask$</a> and <a href="https://qwik.builder.io/tutorial/introduction/store/" target="_blank" rel="noopener">useStore</a>.</p>
</div>
<div class="paragraph">
<p>I&#8217;d like to compare <mark>useStore</mark> and <mark>useTask$</mark> with React <mark>useState</mark> and <mark>useEffect</mark> hooks. But remember, Qwik is different!</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The main goal of <mark>render</mark> is to show the component width and height for every window size change.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Just remind, you can find the example above <a href="https://stackblitz.com/edit/qwik-starter-xxdte4?file=README.md" target="_blank" rel="noopener">here</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_ranking_bar">The Ranking bar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As I told you at the start, this article is a sequel to my <a href="https://valor-software.com/articles/tasty-recipes-for-react-d3-the-ranking-bar" target="_blank" rel="noopener">previous article</a>. You can find all related information here. That&#8217;s why I want to get and comment my Qwik version of the Ranking Bar right now.</p>
</div>
<div class="paragraph">
<p>Traditionally, you can look at the full solution <a href="https://stackblitz.com/edit/qwik-starter-nkdscu?file=README.md" target="_blank" rel="noopener">here</a>
Let&#8217;s focus on what&#8217;s changed&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><mark>app.tsx</mark></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import { component$ } from "@builder.io/qwik";
import Chart from "./chart";

export const data = {
  Apple: 100,
  Apricot: 200,
  Araza: 5,
  Avocado: 1,
  Banana: 150,
  // ...
  Feijoa: 11,
  Fig: 0,
};

// Just add a new prop "data"
export default component$(() =&gt; &lt;Chart data={data} /&gt;);</code></pre>
</div>
</div>
<div class="paragraph">
<p><mark>utils.ts</mark></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import * as d3 from "d3";
import { Signal } from "@builder.io/qwik";

// no changes in comparing with the previous article except for typings
export function dotme(texts: d3.Selection&lt;SVGElement, {}, HTMLElement, any&gt;) {
  texts.each(function () {
    // @ts-ignore
    const text = d3.select(this);
    const chars = text.text().split("");

    let ellipsis = text.text(" ").append("tspan").text("...");
    // @ts-ignore
    const minLimitedTextWidth = ellipsis.node().getComputedTextLength();
    ellipsis = text.text("").append("tspan").text("...");

    const width =
      // @ts-ignore
      parseFloat(text.attr("width")) - ellipsis.node().getComputedTextLength();
    const numChars = chars.length;
    const tspan = text.insert("tspan", ":first-child").text(chars.join(""));

    if (width &lt;= minLimitedTextWidth) {
      tspan.text("");
      ellipsis.remove();
      return;
    }

    // @ts-ignore
    while (tspan.node().getComputedTextLength() &gt; width &amp;&amp; chars.length) {
      chars.pop();
      tspan.text(chars.join(""));
    }

    if (chars.length === numChars) {
      ellipsis.remove();
    }
  });
}

// add related types
export interface ChartData {
  [key: string]: number;
}

export interface NormalizedChartRecord {
  fruit: string;
  value: number;
  x: number;
  width: number;
}

// no changes in comparing with the previous article except for typings
export function getNormalizedData(
  data: any,
  width: number
): NormalizedChartRecord[] {
  const tmpData: any[] = [];
  let total = 0;
  for (const key of Object.keys(data)) {
    if (data[key] &gt; 0) {
      tmpData.push({ fruit: key, value: data[key] });
      total += data[key];
    }
  }
  tmpData.sort((a, b) =&gt; b.value - a.value);
  let x = 0;
  for (const record of tmpData) {
    const percent = (record.value / total) * 100;
    const barwidth = (width * percent) / 100;
    record.x = x;
    record.width = barwidth;
    x += barwidth;
  }
  return tmpData;
}

export function setSvgDimension(
  svgRef: Signal&lt;Element | undefined&gt;,
  store: any
) {
  if (svgRef?.value) {
    const { width, height } = svgRef.value.getBoundingClientRect();
    store.width = width;
    store.height = height;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, finally, <mark>chart.tsx</mark>. Please, read my comments in the code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">import {
  component$,
  useStore,
  useClientEffect$,
  useSignal,
  useOnWindow,
  useTask$,
  $,
} from "@builder.io/qwik";
import * as d3 from "d3";
import { ChartData, dotme, getNormalizedData, setSvgDimension } from "./utils";

export interface ChartProps {
  data: ChartData;
}

export default component$(({ data }: ChartProps) =&gt; {
  // store width and height of the component here
  const store = useStore({ width: 0, height: 0 });
  // control the SVG container
  const svgRef = useSignal&lt;Element&gt;();

  // initialization
  useClientEffect$(() =&gt; {
    // update the store
    setSvgDimension(svgRef, store);
  });

  // listen window size changes
  useOnWindow(
    "resize",
    $(() =&gt; {
      // update the store
      setSvgDimension(svgRef, store);
    })
  );

  // track width and height
  useTask$(({ track }: { track: Function }) =&gt; {
    track(() =&gt; store.width);
    track(() =&gt; store.height);
    // alter that, get normalized data
    const normalizedData = getNormalizedData(data, store.width);
    // and, finally, render the component according the new screen size
    render(normalizedData, svgRef, store.width, store.height);
  });

  return &lt;svg class="chart" ref={svgRef} /&gt;;
});

// the following code is close to the related one in the previous article
export function render(
  normalizedData: any,
  svgRef: any,
  width: number,
  height: number
) {
  const svg = d3
    .select(svgRef.value)
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(0,0)");

  const color = d3
    .scaleOrdinal()
    .domain(Object.keys(normalizedData))
    .range(d3.schemeTableau10);

  svg
    .selectAll()
    .data(normalizedData)
    .enter()
    .append("g")
    .append("rect")
    .attr("x", (d: any) =&gt; d.x)
    .attr("width", (d: any) =&gt; d.width - 1)
    .attr("y", 0)
    .attr("height", 50)
    // @ts-ignore
    .attr("fill", (_: any, i: number) =&gt; color(i));

  svg
    .selectAll("text")
    .data(normalizedData)
    .join("text")
    .text((d: any) =&gt; d.fruit)
    .attr("x", (d: any) =&gt; d.x + 5)
    .attr("y", (d: any) =&gt; 30)
    .attr("width", (d: any) =&gt; d.width - 1)
    .attr("fill", "white");

  // @ts-ignore
  svg.selectAll("text").call(dotme);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s run the example and reduce/increase the <a href="https://stackblitz.com/edit/qwik-starter-nkdscu?file=src%2Fcomponents%2Fchart.tsx" target="_blank" rel="noopener">window size</a>.</p>
</div>
<div class="sect2">
<h3 id="_thank_you_for_your_attention_and_qwik_learning">Thank you for your attention, and Qwik learning!</h3>

</div>
</div>
</div>
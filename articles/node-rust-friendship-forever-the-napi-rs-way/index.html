<!DOCTYPE html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta name="generator" content="Scully 0.0.0"><script id="article-micro-data" type="application/ld+json">
            {
            "@context": "https://schema.org/",
            "@type": "BlogPosting",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https://valor-software.com/articles/node-rust-friendship-forever-the-napi-rs-way"
            },
            "headline": "Node & Rust: Friendship Forever. The NAPI-rs Way.",
            "description": "I will provide a NodeJS application that gets a file, uploads it, and transforms it afterward.",
            "image": {
                "@type": "ImageObject",
                "url": "https://valor-software.com/assets/articles/node-rust-friendship-forever-the-napi-rs-way/main-node-rust-friendship.png",
                "width": "",
                "height": ""
            },
            "author": {
                "@type": "Organization",
                "name": "Vyacheslav Chub"
            },
            "publisher": {
                "@type": "Organization",
                "name": "Valor Software",
                "logo": {
                "@type": "ImageObject",
                "url": "https://valor-software.com/assets/img/valor_img/valor-logo.svg",
                "width": "",
                "height": ""
                }
            },
            "datePublished": "Fri Apr 7 2023 10:45:55 GMT+0000 (Coordinated Universal Time)"
            }
        </script>
	<meta charset="utf-8">
	<title>Node &amp; Rust: Friendship Forever. The NAPI-rs Way.</title>
	<base href="/">
	<meta name="robots" content="all">
	<meta property="og:type" content="website">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:image" content="/assets/img/valor-img/valor_social.jpg">

	<!-- Twitter Meta Tags -->
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@ValorSoft">
	<meta name="twitter:creator" content="@ValorSoft">

	<link rel="icon" type="image/x-icon" href="favicon.ico">
	<script>
      window.intercomSettings = {
          app_id: "brxsww1a"
      };
	</script>
	<script src="assets/js/intercom-facade.js"></script>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YD223JL5QN"></script>
	<script>
      window.dataLayer = window.dataLayer || [];

      function gtag() {
          dataLayer.push(arguments);
      }

      gtag('js', new Date());
	</script>
	<script type="text/javascript">
      window.onload = function () {
          if (window.self !== window.top) {
              document.body.innerHTML = `
                <div>
                  <h1>If you see this page, the valor site link you have clicked on is under Clickjacking security attack.</h1>
                  <h2>Please inform our team with the reference of the application from where you clicked this link.</h2>
                  <h2>Click <a href="https://valor-software.com" title='Valor site' target='blank'>here</a> to access valor site safely.</h2>
                </div>
              `;
          }
      };
	</script>
<style>:root{--light_font_col:#E1E1E1}*,:before,:after{box-sizing:border-box}html{tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji"}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,"Apple Color Emoji","Segoe UI Emoji",Segoe UI Symbol,"Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,:before,:after{box-sizing:border-box;border-width:0;border-style:solid;border-color:currentColor}*,:before,:after{--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-transform:translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));border-color:currentColor;--tw-ring-inset:var(--tw-empty, );--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59, 130, 246, .5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-blur:var(--tw-empty, );--tw-brightness:var(--tw-empty, );--tw-contrast:var(--tw-empty, );--tw-grayscale:var(--tw-empty, );--tw-hue-rotate:var(--tw-empty, );--tw-invert:var(--tw-empty, );--tw-saturate:var(--tw-empty, );--tw-sepia:var(--tw-empty, );--tw-drop-shadow:var(--tw-empty, );--tw-filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}:root{--swiper-navigation-size:44px}:root{--swiper-theme-color:#007aff}body,html{height:100%;--tw-bg-opacity:1;background-color:rgba(22,22,23,var(--tw-bg-opacity));scroll-behavior:smooth}</style><link rel="stylesheet" href="styles.10d34ecbab5d2f65.css" media="all" onload="this.media='all'"><noscript><link rel="stylesheet" href="styles.10d34ecbab5d2f65.css"></noscript><style>[_nghost-ng-c1371038418]{position:fixed;bottom:0;left:0;right:0;z-index:10000;width:100%;background:#252829;color:#fff;overflow:hidden;box-sizing:border-box;line-height:24px;display:flex;flex-wrap:nowrap;padding:16px 29px;align-items:center;animation:1s _ngcontent-ng-c1371038418_fadein ease-in-out both}.btn[_ngcontent-ng-c1371038418]{display:block;padding:.4em .8em;font-size:.9em;font-weight:700;border-width:2px;border-style:solid;text-align:center;white-space:nowrap;border-color:transparent}@keyframes _ngcontent-ng-c1371038418_fadein{0%{opacity:0}to{opacity:1}}</style><style>.turbo-table{margin-top:25px}  .turbo-table tbody tr:not(:first-of-type){border-top:1px solid gray}  .turbo-table tbody tr:not(:first-of-type) td:not(:last-of-type){border-right:1px solid gray}  .turbo-table tbody tr:not(:first-of-type) td{padding:5px 10px}  tbody tr:first-of-type{text-align:center}  mark{background-color:#a9a9a9;color:#383838;border-radius:.3em;padding:.1em .25em}  .white{color:#fff}  .small-img{margin:auto;width:40%}  .block-citation{border-left-width:8px;--tw-border-opacity: 1;border-color:rgba(32,32,32,var(--tw-border-opacity));--tw-bg-opacity: 1;background-color:#2c2c2d}  .block-citation>.attribution{padding:0 16px 16px;text-align:right}  .block-citation>blockquote{border:0px;border-radius:3rem}  .block-citation>blockquote>.paragraph:first-of-type:before{content:open-quote;float:left;font-size:3em;margin-right:4px;font-weight:700;line-height:.6em;color:rgba(226,78,99,var(--tw-text-opacity))}  .block-citation>blockquote>.paragraph:first-of-type:after{content:no-close-quote}</style><meta name="description" content="I will provide a NodeJS application that gets a file, uploads it, and transforms it afterward."><meta property="og:title" content="Node &amp; Rust: Friendship Forever. The NAPI-rs Way."><meta property="og:description" content="I will provide a NodeJS application that gets a file, uploads it, and transforms it afterward."><meta property="twitter:title" content="Node &amp; Rust: Friendship Forever. The NAPI-rs Way."><meta property="twitter:description" content="I will provide a NodeJS application that gets a file, uploads it, and transforms it afterward."><style>
      swiper {
        display: block;
      }
    </style><script>window['ScullyIO']='generated';</script></head>
<body scully-version="0.0.0">
<valor-software-site-base-root _nghost-ng-c6223672="" ng-version="16.0.4"><top-menu _ngcontent-ng-c6223672=""><nav class="bg-grey_bg font-workSans text-base fixed top-0 w-full z-10"><div class="px-4 xl:px-28 lg:py-2.5"><div class="flex items-center justify-between h-16"><div class="flex-1 lg:flex-auto lg:hidden"><img src="assets/img/icons/burger-menu.svg" alt="burger menu icon"></div><!----><!----><div class="lg:flex flex-1 lg:flex-auto items-center"><div class="flex-shrink-0"><a routerlink="." class="cursor-pointer block justify-center flex" href="/"><img src="/assets/img/valor-img/valor-logo.svg" alt="Workflow" class="h-6 w-auto sm:h-14"></a></div><div class="hidden lg:block relative ml-20"><div class="flex space-x-2 leading-4"><div class="menu-item">For clients <div class="light-arrow"></div></div><a routerlink="/services" class="menu-item" href="/services">Services</a><a routerlink="/projects" class="menu-item" href="/projects">Portfolio</a><a routerlink="/careers" class="menu-item" href="/careers">Careers</a><a routerlink="/articles" class="menu-item active-route" href="/articles">Blog</a></div><menu-popover class="hidden lg:block"><div class="hidden lg:block"><div class="popover pt-10 px-10 z-20"><div class="arrow"></div><div class="flex justify-between flex-wrap"><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/startups"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/startups.svg"><h3 class="ml-2.5">Startups</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Software development from scratch to market launch</p></div></a></div><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/enterprises"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/enterprises.svg"><h3 class="ml-2.5">Enterprises</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Future-oriented solutions to solve today's problems and anticipate tomorrowâ€™s needs</p></div></a></div><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/smbs"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/smbs.svg"><h3 class="ml-2.5">SMBs</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Budget-wise solutions for small to medium-sized businesses</p></div></a></div><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/non-profit"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/non-profits.svg"><h3 class="ml-2.5">Non-profits</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Technology solutions for non-governmental organizations</p></div></a></div><!----></div></div><div class="backdrop"></div></div><div class="adaptive-popover"><div><a href="/clients/startups"><div class="flex mb-7"><div class="flex items-center"><img src="/assets/img/icons/startups.svg"><h3 class="ml-2.5 text-xl">Startups</h3></div><!----></div></a></div><div><a href="/clients/enterprises"><div class="flex mb-7"><div class="flex items-center"><img src="/assets/img/icons/enterprises.svg"><h3 class="ml-2.5 text-xl">Enterprises</h3></div><!----></div></a></div><div><a href="/clients/smbs"><div class="flex mb-7"><div class="flex items-center"><img src="/assets/img/icons/smbs.svg"><h3 class="ml-2.5 text-xl">SMBs</h3></div><!----></div></a></div><div><a href="/clients/non-profit"><div class="flex"><div class="flex items-center"><img src="/assets/img/icons/non-profits.svg"><h3 class="ml-2.5 text-xl">Non-profits</h3></div><!----></div></a></div><!----></div></menu-popover></div></div><div class="lg:block flex-1 lg:flex-auto"><div class="flex items-end justify-end"><button type="button" class="btn-pink-border text-xs md:text-base"> Get in touch </button></div></div></div></div><div id="mobile-menu" class="adaptive-menu"><div class="px-2 pt-2 pb-3 space-y-1"><div class="menu-item">For clients <div class="light-arrow big"></div></div><menu-popover class="block lg:hidden !m-0"><div class="hidden lg:block"><div class="popover pt-10 px-10 z-20"><div class="arrow"></div><div class="flex justify-between flex-wrap"><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/startups"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/startups.svg"><h3 class="ml-2.5">Startups</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Software development from scratch to market launch</p></div></a></div><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/enterprises"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/enterprises.svg"><h3 class="ml-2.5">Enterprises</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Future-oriented solutions to solve today's problems and anticipate tomorrowâ€™s needs</p></div></a></div><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/smbs"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/smbs.svg"><h3 class="ml-2.5">SMBs</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Budget-wise solutions for small to medium-sized businesses</p></div></a></div><div changesrconhover="" class="w-45% cursor-pointer text-light_font_col mb-12"><a href="/clients/non-profit"><div class="flex mb-2.5"><div class="flex items-center"><img src="/assets/img/icons/non-profits.svg"><h3 class="ml-2.5">Non-profits</h3></div><!----></div><div><p class="text-grey_font_col text-sm">Technology solutions for non-governmental organizations</p></div></a></div><!----></div></div><div class="backdrop"></div></div><div class="adaptive-popover"><div><a href="/clients/startups"><div class="flex mb-7"><div class="flex items-center"><img src="/assets/img/icons/startups.svg"><h3 class="ml-2.5 text-xl">Startups</h3></div><!----></div></a></div><div><a href="/clients/enterprises"><div class="flex mb-7"><div class="flex items-center"><img src="/assets/img/icons/enterprises.svg"><h3 class="ml-2.5 text-xl">Enterprises</h3></div><!----></div></a></div><div><a href="/clients/smbs"><div class="flex mb-7"><div class="flex items-center"><img src="/assets/img/icons/smbs.svg"><h3 class="ml-2.5 text-xl">SMBs</h3></div><!----></div></a></div><div><a href="/clients/non-profit"><div class="flex"><div class="flex items-center"><img src="/assets/img/icons/non-profits.svg"><h3 class="ml-2.5 text-xl">Non-profits</h3></div><!----></div></a></div><!----></div></menu-popover><a routerlink="/services" class="menu-item" href="/services">Services</a><a routerlink="/projects" class="menu-item" href="/projects">Portfolio</a><a routerlink="/careers" class="menu-item" href="/careers">Careers</a><a routerlink="/articles" class="menu-item active-route" href="/articles">Blog</a></div></div></nav></top-menu><!----><div _ngcontent-ng-c6223672="" class="font-workSans" style="min-height: 100%;"><router-outlet _ngcontent-ng-c6223672=""></router-outlet><general-item><article _nghost-ng-c198896663=""><section _ngcontent-ng-c198896663="" class="first-section-half landing-section mt-4 bg-dark_title_col lg:!pb-32 !pb:8"><div _ngcontent-ng-c198896663="" class="container flex items-center flex-col"><breadcrumbs _ngcontent-ng-c198896663="" class="w-full hidden md:block"><div><div class="flex text-grey_font_col"><a href="/" class="underline cursor-pointer">Home</a><span>&nbsp;&gt;&nbsp;</span><a href="/articles" class="underline cursor-pointer"> Articles </a><!----><!----><!----><span>&nbsp;&gt;&nbsp;</span><a href="/" class="disabled"> Node &amp; Rust: Friendship Forever. The Napi-rs Way. </a><!----><!----><!----><!----></div></div><!----></breadcrumbs><!----><!----><div _ngcontent-ng-c198896663="" class="w-full flex flex-col items-center md:mt-12 lg:mt-32 max-w-full lg:max-w-75% text-center text-light_title_col"><p _ngcontent-ng-c198896663="" class="text-20 mb-4">April 7, 2023</p><p _ngcontent-ng-c198896663="" class="text-large font-bold md:text-64 leading-66 mb-8 md:mb-14">Node &amp; Rust: Friendship Forever. The NAPI-rs Way.</p><div _ngcontent-ng-c198896663="" class="w-70 h-70 rounded-full overflow-hidden mb-4"><img _ngcontent-ng-c198896663="" class="w-full h-full object-cover" src="assets/articles/node-rust-friendship-forever-the-napi-rs-way/Slava_Chub.jpg" alt="Vyacheslav Chub"></div><!----><!----><!----><p _ngcontent-ng-c198896663="" class="md:text-large text-24 mb-4">Vyacheslav Chub</p><!----><!----><!----><p _ngcontent-ng-c198896663="" class="text-20">Full Stack Software Engineer</p><!----></div></div></section><section _ngcontent-ng-c198896663="" class="landing-section"><div _ngcontent-ng-c198896663="" class="container pt-4 md:pt-12 flex items-center flex-col article-box !max-w-1010"><div _ngcontent-ng-c198896663="" class="max-w-full"><div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Itâ€™s no secret that NodeJS solutions are not so performative, especially if we consider a solution with a bunch of synchronous operations or vice versa - we work with a tricky multi-thread solution. A good example is image processing or cipher. Despite some performance issues, NodeJS retains its reputation as a mainstream. Moreover, NodeJS tries to be more flexible. A powerful <a href="https://nodejs.org/api/addons.html" target="_blank" rel="noopener">NodeJS Addons</a> functionality allows developers to write some NodeJS functionalities on C++. <a href="https://blog.logrocket.com/rust-and-node-js-a-match-made-in-heaven/" target="_blank" rel="noopener">Node.js with Rust</a> became popular last time. I meant this technique because I will discuss Rust programming language integration with NodeJS. Why Rust? Itâ€™s a good questionâ€¦â€‹ I want to provide some essential facts regarding Rust briefly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Memory-safe approach preventing memory leaks.</p>
</li>
<li>
<p>Type-safe syntax control.</p>
</li>
<li>
<p>No "Data race" issue owing to concurrency management.</p>
</li>
<li>
<p>Programs are compiled in the "ahead-of-time" manner.</p>
</li>
<li>
<p>Utilizes and promotes zero-cost abstractions.</p>
</li>
<li>
<p>No resource-consuming "garbage collectors", no JIT compiler, no virtual machine.</p>
</li>
<li>
<p>Minimal runtime and memory footprint.</p>
</li>
<li>
<p>Very good dependency management tool.</p>
</li>
<li>
<p>Helpful compiler errors with clear and doable recommendations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Apart from that, Rust is multithread friendly and it has a much simpler syntax compared with C/C++.</p>
</div>
<div class="paragraph">
<p>You can find the <a href="https://www.ideamotive.co/blog/rust-vs-cpp-which-technology-should-you-choose" target="_blank" rel="noopener">following resource</a> valuable. <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/fastest/rust-gpp.html" target="_blank" rel="noopener">This resource</a> will persuade you regarding Rust Performance.</p>
</div>
<div class="paragraph">
<p>Itâ€™s Ðµasy to see that the Rust integration described above is a bit difficult. Fortunately, evolution does not come to a halt. Today Iâ€™m glad to introduce a new Animal to our Technological Zoo.</p>
</div>
<div class="sect2">
<h3 id="_meet_napi_rs">Meet NAPI-RS!</h3>
<div class="paragraph">
<p><a href="https://napi.rs/" target="_blank" rel="noopener">NAPI-RS</a> is a framework for building pre-compiled Node.js addons in Rust.</p>
</div>
<div class="paragraph">
<p>Letâ€™s jump off the bat!</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_aim">The Aim</h3>
<div class="paragraph">
<p>Of course, the article aims to introduce you <mark>napi-rs</mark> as the easiest way to integrate NodeJS with Rust. The best way to do it is to provide a more complicated example than a standard one.</p>
</div>
<div class="paragraph">
<p>I will provide a NodeJS application that gets a file, uploads it, and transforms it afterward. Letâ€™s say it is reducing the saturation. The image operation above should be provided on the Rust side.</p>
</div>
<div class="paragraph">
<p>But before that, letâ€™s try the standard functionality.</p>
</div>
</div>
<div class="sect2">
<h3 id="_package_template">Package Template</h3>
<div class="paragraph">
<p>First, you need to <a href="https://www.rust-lang.org/tools/install" target="_blank" rel="noopener">install Rust</a>. <mark>Cargo</mark> builder is included there.</p>
</div>
<div class="paragraph">
<p>Second, I recommend creating a new project via the following <a href="https://github.com/napi-rs/package-template" target="_blank" rel="noopener">template</a>.
Third, <mark>yarn</mark> is recommended here.</p>
</div>
<div class="paragraph">
<p>Itâ€™s time to cover all essential points.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation_of_nodejs_dependencies_and_build">Installation of NodeJS dependencies and build</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yarn install
yarn build</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_rust_part">Rust Part</h3>
<div class="paragraph">
<p><mark>Cargo.toml</mark> contains all information regarding the Rust package, including dependencies. This file is similar to package.json in NodeJS.</p>
</div>
<div class="paragraph">
<p><strong><mark>src/lib.rs</mark></strong></p>
</div>
<div class="paragraph">
<p>The file above contains Rust-defined functions for future exporting. In this example, a defined function #plus_100 #adds 100 to the input parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">#![deny(clippy::all)]

use napi_derive::napi;

#[napi]
pub fn plus_100(input: u32) -&gt; u32 {
  input + 100
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nodejs_part">NodeJS part</h3>
<div class="paragraph">
<p>Itâ€™s obvious to see <mark>package.json</mark> and other JS stuff here because we are talking about Rust and NodeJS integration. <mark>package.json</mark> contains required dependencies like <mark>@napi-rs/cli</mark> that allow you to build the solution. Also, pay attention to the following files.</p>
</div>
<div class="paragraph">
<p><strong><mark>./index.js</mark></strong></p>
</div>
<div class="paragraph">
<p>This file contains your library binding with its exporting. Please look at the last lines of code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const { plus100 } = nativeBinding;

module.exports.plus100 = plus100;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do you remember Rustâ€™s <mark>plus100</mark> definition above? These lines
precisely represent a bridge between Rust and NodeJS.</p>
</div>
<div class="paragraph">
<p><strong><mark>./index.d.ts</mark></strong></p>
</div>
<div class="paragraph">
<p>This file contains Typescript definitions (signatures) of your Rust functionality.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">/* tslint:disable */
/* eslint-disable */

/* auto-generated by NAPI-RS */

export function plus100(input: number): number</code></pre>
</div>
</div>
<div class="paragraph">
<p>Important note! You shouldnâ€™t edit the files above because they are autogenerated and change every Rust definition update after completing the <mark>yarn build</mark> command.</p>
</div>
<div class="paragraph">
<p><strong><mark>./simple-test.js</mark></strong></p>
</div>
<div class="paragraph">
<p>The following code illustrates how to run a Rust-defined function. Pay attention to the first line. You should import the function from <mark>./index.js</mark> (see above).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const { plus100 } = require("./index");

console.assert(plus100(0) === 100, "Simple test failed");

console.info("Simple test passed");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Letâ€™s run it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">node simple-test</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_image_processing">Image processing</h3>
<div class="paragraph">
<p>After we are sure your solution works well, letâ€™s make the solution image-processing friendly. Letâ€™s pass the following steps.</p>
</div>
<div class="paragraph">
<p><strong>Change</strong> <strong><mark>./Cargo.toml</mark></strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">[lib]
crate-type = ["cdylib"]
path = "lib/lib.rs"</code></pre>
</div>
</div>
<div class="paragraph">
<p><mark>path = "lib/lib.rs"</mark> has been added. Now we use the <mark>lib</mark> folder instead <mark>src</mark> for Rust code. <mark>src</mark> folder could be reserved for future JS/TS code. Letâ€™s remove the <mark>src</mark> folder for now.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rust_stuff">Rust Stuff</h3>
<div class="paragraph">
<p>First, install the expected Rust dependency (<mark>image</mark> package).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cargo add image</code></pre>
</div>
</div>
<div class="paragraph">
<p>Second, create <a href="https://github.com/buchslava/napi-rs-images/blob/main/lib/lib.rs" target="_blank" rel="noopener">lib/lib.rs</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">#![deny(clippy::all)]

use image::{GenericImageView, ImageBuffer, Pixel};

use napi_derive::napi;

#[napi]
pub fn darker(filename: String, saturation: u8) {
  let img = image::open(filename.clone()).expect("File not found!");
  let (w, h) = img.dimensions();
  let mut output = ImageBuffer::new(w, h);

  for (x, y, pixel) in img.pixels() {
    output.put_pixel(x, y, pixel.map(|p| p.saturating_sub(saturation)));
  }

  output.save(filename).unwrap();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong><mark>#[napi]</mark></strong> attribute is a marker that the function should be used in JS/TS code.</p>
</div>
<div class="paragraph">
<p>The function above takes the filename and saturation, reads the file, applies the saturation, and rewrites the file.</p>
</div>
<div class="paragraph">
<p>Letâ€™s rebuildâ€¦â€‹</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yarn build</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result, <mark>index.js</mark> and <mark>index.d.ts</mark> should be updated.</p>
</div>
<div class="paragraph">
<p>Copy <a href="https://github.com/buchslava/napi-rs-images/blob/main/cube.png" target="_blank" rel="noopener">this picture</a> to the root of the project.</p>
</div>
<div class="paragraph">
<p>Also, letâ€™s change <a href="https://github.com/buchslava/napi-rs-images/blob/main/simple-test.js" target="_blank" rel="noopener">simple-test.js</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const { darker } = require("./index");

darker("./cube.png", 50);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Itâ€™s time to run it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">node simple-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or run the commands below if you want to reproduce all the steps from the start.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git clone git@github.com:buchslava/napi-rs-images.git
cd napi-rs-images
yarn
yarn build
node simple-test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look at the following changes</p>
</div>
<div class="imageblock img">
<div class="content">
<img src="assets/articles/node-rust-friendship-forever-the-napi-rs-way/img1.png" alt="img1">
</div>
</div>
<div class="paragraph">
<p>Our Rust part is ready and itâ€™s time to implement a web application that allows us to upload/desaturate the file and show it after.</p>
</div>
<div class="paragraph">
<p>If you want to try the application immediately you can play with <a href="https://github.com/buchslava/napi-rs-images" target="_blank" rel="noopener">napi-rs images</a>. Otherwise, please read my explanations below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the_final_stitches">The Final Stitches</h3>
<div class="paragraph">
<p>First we need to install expected NodeJS dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yarn add ejs
yarn add express
yarn add express-ejs-layouts
yarn add express-fileupload
yarn add uuid</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make <mark>storage</mark> folder under the root of the project and add it to <mark>./.gitignore</mark>.</p>
</div>
<div class="paragraph">
<p>Add the <a href="https://github.com/buchslava/napi-rs-images/blob/main/server.js" target="_blank" rel="noopener">./server.js</a> to the root of the project.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const fs = require("fs");
const path = require("path");

const express = require("express");
const ejsLayouts = require("express-ejs-layouts");
const fileUpload = require("express-fileupload");
const uuidv4 = require("uuid").v4;

const { darker } = require("./index");

const STORAGE_DIR = "storage";

const app = express();

app.use(fileUpload());
app.set("view engine", "ejs");
app.use(ejsLayouts);
app.use("/storage", express.static(path.join(__dirname, STORAGE_DIR)));
app.use(express.urlencoded({ extended: true }));

app.get("/", async (req, res) =&gt; {
  let files = await fs.promises.readdir(path.join(__dirname, STORAGE_DIR));
  files = files
    .map((fileName) =&gt; ({
      name: fileName,
      time: fs
        .statSync(path.join(__dirname, STORAGE_DIR, fileName))
        .mtime.getTime(),
    }))
    .sort((a, b) =&gt; a.time - b.time)
    .map((v) =&gt; v.name);
  return res.render("upload", { files: files.reverse() });
});

app.post("/uploads", function (req, res) {
  const file = req.files.upload;
  const extname = path.extname(file.name);
  const uuid = uuidv4();
  const filePath = path.join(__dirname, STORAGE_DIR, `${uuid}${extname}`);

  file.mv(filePath, (err) =&gt; {
    if (err) {
      return res.status(500).send(err);
    }
    try {
      darker(filePath, +req.body.saturation);
    } catch (e) {
      return res.status(500).send(e);
    }
    res.redirect("/");
  });
});

app.listen(3000);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, add <mark>"start": "node server"</mark>, to the <mark>scripts</mark> section in .<mark>/package.json</mark>.</p>
</div>
<div class="paragraph">
<p>I donâ€™t want to explain many of the solutions above because itâ€™s obvious for a NodeJS folk. I just want to pay attention to the points below.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>There are two endpoints: <mark>/</mark> and <mark>/upload</mark>.</p>
</li>
<li>
<p><mark>/</mark> provides us with an upload form and a list of the uploaded and desaturated images.</p>
</li>
<li>
<p><mark>/upload</mark> uploads and desaturates an uploaded image and redirects to <mark>/</mark>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, please look at image desaturation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">try {
  darker(filePath, +req.body.saturation);
} catch (e) {
  return res.status(500).send(e);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the fact that we take the Saturation Value from the request <mark>+req.body.saturation</mark> as a number, and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">let files = await fs.promises.readdir(path.join(__dirname, STORAGE_DIR));
files = files
  .map((fileName) =&gt; ({
    name: fileName,
    time: fs
      .statSync(path.join(__dirname, STORAGE_DIR, fileName))
      .mtime.getTime(),
  }))
  .sort((a, b) =&gt; a.time - b.time)
  .map((v) =&gt; v.name);
return res.render("upload", { files: files.reverse() });</code></pre>
</div>
</div>
<div class="paragraph">
<p>where STORAGE_DIR is <mark>storage</mark> (see above) and we pass a sorted list of the uploaded files to the related EJS template.</p>
</div>
<div class="paragraph">
<p>Related EJS templates are below.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/buchslava/napi-rs-images/blob/main/views/layout.ejs" target="_blank" rel="noopener">views/layout.ejs</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8" /&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;

    &lt;link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    /&gt;
    &lt;title&gt;Uploads&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;%- body %&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/buchslava/napi-rs-images/blob/main/views/upload.ejs" target="_blank" rel="noopener">views/upload.ejs</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;div class="container"&gt;
  &lt;form
    class="w-50 mx-auto my-3"
    action="/uploads"
    method="post"
    enctype="multipart/form-data"
  &gt;
    &lt;div class="mb-3"&gt;
      &lt;input class="form-control" type="file" name="upload" required /&gt;
    &lt;/div&gt;
    &lt;div class="w-50 d-flex form-outline align-middle"&gt;
      &lt;label class="form-label text-nowrap pr-3" for="saturation"
        &gt;% saturation&amp;nbsp;&lt;/label
      &gt;
      &lt;input
        name="saturation"
        value="65"
        type="number"
        id="saturation"
        class="form-control"
      /&gt;
    &lt;/div&gt;
    &lt;button class="btn btn-primary"&gt;Upload&lt;/button&gt;
  &lt;/form&gt;

  &lt;div class="container"&gt;
    &lt;% for (const file of files){ %&gt;
    &lt;div class="row mb-3"&gt;
      &lt;img src="/storage/&lt;%= file %&gt;" class="card-img-top" alt="Image" /&gt;
    &lt;/div&gt;
    &lt;% } %&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Itâ€™s time to test the whole solution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yarn start</code></pre>
</div>
</div>
<div class="paragraph">
<p>and try <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a></p>
</div>
<div class="paragraph">
<p>Finally, letâ€™s upload a couple of images.</p>
</div>
<div class="imageblock img">
<div class="content">
<img src="assets/articles/node-rust-friendship-forever-the-napi-rs-way/img2.png" alt="img2">
</div>
</div>
<div class="imageblock img">
<div class="content">
<img src="assets/articles/node-rust-friendship-forever-the-napi-rs-way/img3.png" alt="img3">
</div>
</div>
<div class="imageblock img">
<div class="content">
<img src="assets/articles/node-rust-friendship-forever-the-napi-rs-way/img4.png" alt="img4">
</div>
</div>
<div class="imageblock img">
<div class="content">
<img src="assets/articles/node-rust-friendship-forever-the-napi-rs-way/img5.png" alt="img5">
</div>
</div>
<div class="paragraph">
<p>I guess you will satisfy your curiosity about performance if you upload and process bigger images.</p>
</div>
<div class="paragraph">
<p>In conclusion, I want to mean a fact from <a href="https://github.com/napi-rs/napi-rs" target="_blank" rel="noopener">here</a>.</p>
</div>
<div class="paragraph">
<p><em>"One nice feature is that this crate allows you to build add-ons purely with the Rust/JavaScript toolchain and without involving node-gyp."</em></p>
</div>
<div class="paragraph">
<p>Thatâ€™s like music to the ears of Node Folks.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_happy_coding">Happy coding!</h2>
<div class="sectionbody">

</div>
</div></div></div></section><!----><section _ngcontent-ng-c198896663="" class="landing-section"><h1 _ngcontent-ng-c198896663="" class="main-title">More Articles</h1><div _ngcontent-ng-c198896663="" class="container"><blog-preview _ngcontent-ng-c198896663=""><swiper class="article_swiper swiper swiper-initialized swiper-horizontal swiper-pointer-events"><!----><!----><div class="swiper-pagination swiper-pagination-clickable swiper-pagination-bullets swiper-pagination-horizontal"><span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span><span class="swiper-pagination-bullet"></span><span class="swiper-pagination-bullet"></span></div><!----><div class="swiper-wrapper" style="transform: translate3d(0px, 0px, 0px);"><!----><!----><div data-swiper-slide-index="0" class="swiper-slide swiper-slide-active" style="width: 733px; margin-right: 40px;"><!----><a href="/articles/game-n-qwik-episode-02" class="block w-full cursor-pointer"><blog-portfolio-item><div class="article-item"><div class="img-container-auto zoom-img-scale"><img class="w-full h-full object-cover" src="assets/articles/game-n-qwik-episode-02/Main-Game-n-qwik2.png" alt="Game-n-Qwik. Episode 02."></div><div class="text-container"><p>Game-n-Qwik. Episode 02.</p></div></div></blog-portfolio-item></a><!----><!----><!----><!----><!----></div><div data-swiper-slide-index="1" class="swiper-slide swiper-slide-next" style="width: 733px; margin-right: 40px;"><!----><a href="/articles/game-n-qwik-episode-01" class="block w-full cursor-pointer"><blog-portfolio-item><div class="article-item"><div class="img-container-auto zoom-img-scale"><img class="w-full h-full object-cover" src="assets/articles/game-n-qwik-episode-01/Main_Game-n-qwik1.png" alt="Game-n-Qwik. Episode 01."></div><div class="text-container"><p>Game-n-Qwik. Episode 01.</p></div></div></blog-portfolio-item></a><!----><!----><!----><!----><!----></div><div data-swiper-slide-index="2" class="swiper-slide" style="width: 733px; margin-right: 40px;"><!----><a href="/articles/fostering-innovation-through-collaboration-outside-contributors-first-hand-experience" class="block w-full cursor-pointer"><blog-portfolio-item><div class="article-item"><div class="img-container-auto zoom-img-scale"><img class="w-full h-full object-cover" src="assets/articles/fostering-innovation-through-collaboration-outside-contributors-first-hand-experience/Main-fostering.png" alt="Fostering Innovation Through Collaboration: Outside Contributor's First-Hand Experience"></div><div class="text-container"><p>Fostering Innovation Through Collaboration: Outside Contributor's First-Hand Experience</p></div></div></blog-portfolio-item></a><!----><!----><!----><!----><!----></div><!----><!----><!----><!----></div><!----></swiper><!----><!----></blog-preview></div></section><!----><!----></article><!----><!----><!----></general-item><!----></div><app-footer _ngcontent-ng-c6223672=""><footer><div class="px-4 xl:px-28 pb-6"><div class="w-full flex flex-col-reverse md:flex-row items-center justify-between border-t-2 border-placeholder_col pt-6"><div class="flex-shrink-0"><a routerlink="." class="cursor-pointer" href="/"><img src="/assets/img/valor-img/valor-logo.svg" alt="Workflow" class="h-14 w-70 md:w-full"></a></div><div class="hidden lg:flex items-center"><div class="leading-4 flex"><div class="lg:w-75 !mr-10"><a href="https://www.linkedin.com/company/valor-software/about/" target="_blank" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">LinkedIn</a></div><div class="lg:w-75 !mr-10"><a href="https://www.facebook.com/valorsoftware/" target="_blank" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">Facebook</a></div><div class="lg:w-75 !mr-10"><a href="https://twitter.com/ValorSoft" target="_blank" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">Twitter</a></div><div class="lg:w-75 !mr-10"><a href="https://www.instagram.com/valor.software/" target="_blank" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">Instagram</a></div><div class="lg:w-75 !mr-10"><a href="https://dribbble.com/valor-labs" target="_blank" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">Dribbble</a></div><div class="lg:w-75 !mr-10"><a href="https://www.behance.net/ValorSoftware" target="_blank" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">Behance</a></div><div class="lg:w-75 !mr-10"><a href="https://github.com/valor-software" rel="noopener" class="block transition-all text-header_font_col hover:font-bold">GitHub</a></div><div class="lg:w-75 !mr-10"><a href="https://valorsoftware.medium.com/" class="block transition-all text-header_font_col hover:font-bold">Medium</a></div></div><div class="hidden 2xl:block 2xl:flex-1 2xl:flex-auto ml-10"><div class="flex items-end justify-end"><button type="button" class="btn-pink-border text-xs md:text-base"> Get in touch </button></div></div></div><div class="flex flex-wrap lg:hidden mb-4 md:mb-0 justify-center md:justify-between w-full md:w-auto"><a href="https://www.linkedin.com/company/valor-software/about/" target="_blank" rel="noopener" class="w-20% md:w-auto flex justify-center md:mr-10 text-header_font_co mb-4 md:mb-0"><img src="assets/img/icons/social/linkedin.svg" alt=""></a><a href="https://www.instagram.com/valor.software/" target="_blank" rel="noopener" class="flex justify-center w-20% md:w-auto block md:mr-10 text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/instagram.svg" alt=""></a><a href="https://twitter.com/ValorSoft" target="_blank" rel="noopener" class="flex justify-center w-20% md:w-auto block md:mr-10 text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/twitter.svg" alt=""></a><a href="https://dribbble.com/valor-labs" target="_blank" rel="noopener" class="flex justify-center w-20% md:w-auto block md:mr-10 text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/dribble.svg" alt=""></a><a href="https://www.behance.net/ValorSoftware" target="_blank" rel="noopener" class="flex justify-center w-20% md:w-auto block md:mr-10 text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/behance.svg" alt=""></a><a href="https://www.facebook.com/valorsoftware/" target="_blank" rel="noopener" class="flex justify-center w-20% md:w-auto block md:mr-10 text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/facebook.svg" alt=""></a><a href="https://github.com/valor-software" target="_blank" rel="noopener" class="flex justify-center md:mr-10 w-20% md:w-auto block text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/github.svg" alt=""></a><a href="https://valorsoftware.medium.com/" target="_blank" rel="noopener" class="flex justify-center w-20% md:w-auto block text-header_font_col mb-4 md:mb-0"><img src="assets/img/icons/social/medium.svg" alt=""></a></div></div><div class="flex flex-col justify-center mt-4 md:mt-7"><p class="m-0 text-center text-header_font_col text-sm">Â© 2023, Valor Software All Rights Reserved</p><a routerlink="/privacy-policy" class="m-0 text-center text-header_font_col text-sm link" href="/privacy-policy">Privacy Policy </a></div></div></footer></app-footer><!----><cookie-consent-banner _ngcontent-ng-c6223672="" _nghost-ng-c1371038418=""><div _ngcontent-ng-c1371038418="" class="banner flex flex-col items-center lg:flex-row justify-between px-4 xl:px-20 font-workSans !w-full"><div _ngcontent-ng-c1371038418="" class="flex flex-col"><span _ngcontent-ng-c1371038418="" class="text-20">This website uses cookies.</span><span _ngcontent-ng-c1371038418="" id="cookieconsent:desc" class="leading-18"> We use cookies to make sure this website can function. By continuing to browse this website, you agree to our use of cookies. <a _ngcontent-ng-c1371038418="" aria-label="learn more about our privacy policy" href="https://valor-software.com/privacy-policy" target="_blank" class="text-center text-header_font_col text-sm link">Learn more </a></span></div><div _ngcontent-ng-c1371038418="" class="flex items-center pt-5 lg:pt-0"><button _ngcontent-ng-c1371038418="" class="btn btn-pink flex md:justify-between justify-center py-5 px-10 w-full lg:w-auto"> Accept all cookies </button></div></div></cookie-consent-banner><!----></valor-software-site-base-root>
<script async="" src="assets/js/prettify.min.js"></script>
<script id="ScullyIO-transfer-state"></script><script src="runtime.4c7d92041b1852c4.js" type="module"></script><script src="polyfills.2066255b7190fd43.js" type="module"></script><script src="main.5ec7152d5e620967.js" type="module"></script>

</body></html>